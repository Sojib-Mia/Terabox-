import re
import os
import requests
from telegram import Update
from telegram.ext import (
    Application,
    MessageHandler,
    CommandHandler,
    ContextTypes,
    filters
)
from dotenv import load_dotenv

# .env ‡¶´‡¶æ‡¶á‡¶≤ ‡¶•‡ßá‡¶ï‡ßá ‡¶ü‡ßã‡¶ï‡ßá‡¶® ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®
load_dotenv()
TOKEN = os.getenv("BOT_TOKEN")

# ‡¶ü‡ßá‡¶∞‡¶æ‡¶¨‡¶ï‡ßç‡¶∏‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶π‡ßá‡¶°‡¶æ‡¶∞ (‡¶¨‡ßç‡¶∞‡¶æ‡¶â‡¶ú‡¶æ‡¶∞ ‡¶∏‡¶ø‡¶Æ‡ßÅ‡¶≤‡ßá‡¶∂‡¶®)
HEADERS = {
    "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36",
    "Referer": "https://www.terabox.com/",
}

async def download_video(url: str) -> bytes:
    """‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßá ‡¶Æ‡ßá‡¶Æ‡ßã‡¶∞‡¶ø‡¶§‡ßá ‡¶∞‡¶ø‡¶ü‡¶æ‡¶∞‡ßç‡¶® ‡¶ï‡¶∞‡ßá"""
    try:
        # ‡¶∞‡¶ø‡¶°‡¶æ‡¶á‡¶∞‡ßá‡¶ï‡ßç‡¶ü ‡¶π‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡¶≤‡¶ø‡¶Ç
        response = requests.get(url, headers=HEADERS, allow_redirects=True, timeout=15)
        final_url = response.url
        
        # ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶®‡ßç‡¶ü ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°
        video_response = requests.get(final_url, headers=HEADERS, stream=True, timeout=30)
        video_response.raise_for_status()
        
        # ‡¶Æ‡ßá‡¶Æ‡ßã‡¶∞‡¶ø‡¶§‡ßá ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡¶Ç‡¶ó‡ßç‡¶∞‡¶π
        video_content = b""
        for chunk in video_response.iter_content(chunk_size=1024*1024):
            if chunk:
                video_content += chunk
        return video_content
    
    except Exception as e:
        print(f"Download Error: {e}")
        return None

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶π‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡¶≤‡¶ø‡¶Ç (‡¶ï‡ßã‡¶® ‡¶´‡¶æ‡¶á‡¶≤ ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶õ‡¶æ‡ßú‡¶æ‡¶á)"""
    text = update.message.text
    
    # ‡¶ü‡ßá‡¶∞‡¶æ‡¶¨‡¶ï‡ßç‡¶∏ ‡¶≤‡¶ø‡¶Ç‡¶ï ‡¶°‡¶ø‡¶ü‡ßá‡¶ï‡ßç‡¶ü
    video_urls = re.findall(
        r'(https?://(?:www\.)?(?:terabox\.com|terafileshare\.com|terabox\.app)/\S+)', 
        text, 
        re.IGNORECASE
    )
    
    if not video_urls:
        await update.message.reply_text("‚ùå Invalid TeraBox Link!")
        return
    
    status_msg = await update.message.reply_text("üì• Downloading...")
    
    try:
        video_content = await download_video(video_urls[0])
        if not video_content:
            raise Exception("Download failed")
        
        # ‡¶∏‡¶∞‡¶æ‡¶∏‡¶∞‡¶ø ‡¶Æ‡ßá‡¶Æ‡ßã‡¶∞‡¶ø ‡¶•‡ßá‡¶ï‡ßá ‡¶≠‡¶ø‡¶°‡¶ø‡¶ì ‡¶∏‡ßá‡¶®‡ßç‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®
        await update.message.reply_video(
            video=video_content,
            caption="‚¨áÔ∏è Downloaded by @YourBotName",
            reply_to_message_id=update.message.message_id,
            read_timeout=200,
            write_timeout=200
        )
        await status_msg.delete()
        
    except Exception as e:
        print(f"Error: {e}")
        await status_msg.edit_text("üò¢ Failed to download. Check link or try later.")

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """‡¶∏‡ßç‡¶ü‡¶æ‡¶∞‡ßç‡¶ü ‡¶ï‡¶Æ‡¶æ‡¶®‡ßç‡¶° ‡¶π‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶°‡¶≤‡¶æ‡¶∞"""
    await update.message.reply_text(
        "üåü Welcome to TeraBox Direct Download Bot!\n"
        "Send any TeraBox link to get instant video."
    )

def main():
    """‡¶¨‡¶ü ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®"""
    application = Application.builder().token(TOKEN).build()
    application.add_handler(CommandHandler("start", start))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
    application.run_polling()

if __name__ == "__main__":
    main()
